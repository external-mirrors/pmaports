# Co-Maintainer: Pablo Correa Gomez <pabloyoyoista@postmarketos.org>
maintainer="Casey Connolly <kcxt@postmarketos.org>"
pkgname=postmarketos-test
pkgver=1.3.0
pkgrel=0
pkgdesc="Common test utilities for postmarketOS"
url="https://postmarketos.org"
arch="noarch"
license="GPL2"
depends="devicepkg-utils"
source="
	initramfs-files-bootrr.files
	initramfs-test-unl0kr.sh
	initramfs-test-suspend.sh
	initramfs-test-bootrr.sh
"
options="!check"

# Tests that are common to all devices
# TODO: more tests
# maybe test cpu frequency scaling, thermals under load, etc.
subpackages="
	$pkgname-bootrr
	$pkgname-suspend:_test
	$pkgname-shell
	$pkgname-unl0kr
"

package() {
	mkdir -p $pkgdir
}

_test() {
	# no install_if here, these tests are generic but should be enabled
	# on a per-device basis. Depend on the relevant test in your devices
	# pmtest subpackage
	_testname=${subpkgname#postmarketos-test-}
	_priority=${_priority:-90}

	# Install the test script for both initramfs and rootfs
	for _type in initramfs rootfs; do
		_script="$srcdir/$_type-test-$_testname.sh"
		_files="$srcdir/$_type-files-$_testname.files"

		if [ -f "$_script" ]; then
			install -Dm755 "$_script" \
				"$subpkgdir"/usr/libexec/pmos-tests-"$_type"/"$_priority"-"$_testname".sh
		fi
		if [ -f "$_files" ]; then
			install -Dm644 "$_files" \
				"$subpkgdir"/usr/share/mkinitfs/files/"$_priority"-"$_testname".files
		fi
	done
}

bootrr() {
	depends="bootrr"
	_priority=00
	_test
}

# Installs a "test" which just runs a shell on the console for debugging
shell() {
	mkdir -p "$subpkgdir"/usr/libexec/pmos-tests-initramfs
	echo -e "#!/bin/sh\n\nexec sh" > "$subpkgdir"/usr/libexec/pmos-tests-initramfs/99-sh
	chmod +x "$subpkgdir"/usr/libexec/pmos-tests-initramfs/99-sh
}

unl0kr() {
	depends="unl0kr"
	_priority=30
	_test
}

sha512sums="
bd0ed41c4dba232b6ac211ae58cad83b15a4408829cd8df0a866453b014c8d4b17900d9310e8a2a02248f6da8853bdd2b04ed96c250204def8e086c0ba15b9e7  initramfs-files-bootrr.files
407180b49c1a05f12bd6ee6e59dca0a6e74fe7b01f195087dcf2865598c47827d0bb569afdba55defa2f9a16437230fa62aa64f35111508b906bcbf9537acba4  initramfs-test-unl0kr.sh
73d75e067f6bb99dab219e0154514841462dc171644756dcdfcb2daa039bd3052d61f35996608499fb0958042cc817ba0ac8196410c68e9133c2670d4cf36529  initramfs-test-suspend.sh
f5568803fe5d0254da222e09e06a062f77a98cfa5f438c54c788f6a08d56ea1a7b85f75595ad46c2a173e95681df58552ae572eba30b3239d5e4c225b4c54a2a  initramfs-test-bootrr.sh
"
