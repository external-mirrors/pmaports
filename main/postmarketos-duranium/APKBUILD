# Maintainer: Clayton Craft <clayton@craftyguy.net>
pkgname=postmarketos-duranium
pkgver=1
pkgrel=0
pkgdesc="Configuration files for building and booting immutable postmarketOS images"
url="https://postmarketos.org"
options="!check"  # no tests
depends="
	f0rmz
	shadow
	tar
	unl0kr
"
# x86: f0rmz
arch="noarch !x86"
license="GPL-3.0-or-later"
replaces="systemd"  # For overwriting tmpfiles.d/{opt,var}.conf

_source644="
	usr/lib/repart.d/00-esp.conf
	usr/lib/repart.d/10-usr-verity-sig.conf
	usr/lib/repart.d/11-usr-verity.conf
	usr/lib/repart.d/12-usr.conf
	usr/lib/repart.d/20-usr-verity-sig.conf
	usr/lib/repart.d/21-usr-verity.conf
	usr/lib/repart.d/22-usr.conf
	usr/lib/repart.d/30-root.conf
	usr/lib/systemd/system-preset/80-duranium.preset
	usr/lib/sysupdate.d/10-usr-verity-sig.transfer
	usr/lib/sysupdate.d/11-usr-verify.transfer
	usr/lib/sysupdate.d/12-usr.transfer
	usr/lib/sysupdate.d/20-uki.transfer
	usr/lib/sysusers.d/10-pmos-user.conf
	usr/lib/tmpfiles.d/opt.conf
	usr/lib/tmpfiles.d/var.conf
	usr/share/f0rmz/f0rmz.conf.d/firstboot.conf
	usr/share/mkinitfs/files-extra/10-duranium-base.files
	usr/share/mkinitfs/modules-extra/10-duranium-base.modules
"

_source755="
	usr/bin/do-factory-reset
"

# Avoid filename based checksum conflicts by including the whole path:
# https://gitlab.alpinelinux.org/alpine/abuild/-/issues/10013
flatpath() {
	local i
	for i in $@; do
		echo "rootfs-$i" | sed s./.-.g
	done
}
source="$(flatpath $_source440 $_source600 $_source644 $_source755)"

package() {
	for i in $_source644; do
		install -Dm644 "$srcdir/$(flatpath "$i")" "$pkgdir/$i"
	done
	for i in $_source755; do
		install -Dm755 "$srcdir/$(flatpath "$i")" "$pkgdir/$i"
	done
}

sha512sums="
b0f320f2ea81c29fa9030abac998e725e098c74bb2ffb76ee2711da4c88615ad46a0e5359b98198648879551781580a0128b57a2ef1ca6a3e03448b01f533065  rootfs-usr-lib-repart.d-00-esp.conf
be7f90bd96fcad6ccf2b434a4b9ce9bc620b63558df0eddd088d86bcbeb778ff097b6d7db0a021d4322bb2ff908eb65f41840e10b11a479e15986a0b02331bf0  rootfs-usr-lib-repart.d-10-usr-verity-sig.conf
8dab35b6c5b61936a8a5f7c6872efe77550f70603a90286c874e9b3c12b25214823c89dd32517b0733110a2f92d0908d0adb6a7bff68f83163d2882e4167b4f6  rootfs-usr-lib-repart.d-11-usr-verity.conf
a2ebcf35620a8c2dcd06dff50b6d17b02e8b688f98c6f7e1bb9727733df20742669cb3926a003ccdb1091bc8a337fdc39cc774de509f1b155f3bd3b45a86f8ef  rootfs-usr-lib-repart.d-12-usr.conf
9aa66e6472ce58da316357c61b8a1538d0d8829f6568ec404efc58ea7ad5d06f5f806cb7e1bf726eb9941181971d0f7131c34a446a52eedc96f3388d1c31c18f  rootfs-usr-lib-repart.d-20-usr-verity-sig.conf
1c452cec92a07859e7bed68ea6b67143d9329446db36eb4aa796424609cc6d96ad2e19d8be53bba776fc2efa75b02c87ec7557eaf233926afd1609611f38a81a  rootfs-usr-lib-repart.d-21-usr-verity.conf
f1833d1627640a30dcb7aebc4ad4296c00f1799168712bf556e54ce74f7e56002b0a37e42ea20bfd10a02d32a9e7b7750c6e8d1b957c416903cd6e1bb19d25c6  rootfs-usr-lib-repart.d-22-usr.conf
ee77d7903f108ef3566ca99091e95aeefc70f19930fe635b6110c71566225beb9675356162628efeb5d4c5cc6e386127035d8c34fdbe5ca28b123b69f4e15ddc  rootfs-usr-lib-repart.d-30-root.conf
23f3833baddaca7050d59cb5376e5c13e7ce2704ebed2bfea6cdde7e487c7e9a7ef752fd49388f0375cdf2d7a39c1909fd6251e6ab0862a7b252404c51b8f83f  rootfs-usr-lib-systemd-system-preset-80-duranium.preset
6b06bbe126a2caa1279c3c1c2cb6974660b93e361c08446ca7dc537d08c66d894312f3df0a8ea4ccb5aeb065dc625800b31ca373c53a7eaeff6f47e98b9e9d2a  rootfs-usr-lib-sysupdate.d-10-usr-verity-sig.transfer
fc7c5d5ff14e1e86cb8f47423aff301ff31ba9a8d0d03402a99e5d2516520e4272d34aa7ae59d41512b9d1f40d19e29a8d424adb17f942b2df5476173016cdc5  rootfs-usr-lib-sysupdate.d-11-usr-verify.transfer
c2b5a0cfea0afa0b0b922e47abc4e2cf71ad6f543fa1a836e876da76afb6ae5a90953a8501bbee24cb92e2a730c92296e0ac4009e58805b9ff964c10f829e9be  rootfs-usr-lib-sysupdate.d-12-usr.transfer
4d0001f1d8976010ac8873a8d4a6935305943ba1a1d31a44c31054587f5aefcd3032df0aea9e77ec04752be0ff2002dad61bfc6a25d72c959cd4c9feec02c2c9  rootfs-usr-lib-sysupdate.d-20-uki.transfer
fa1c3dd727fd20d16d18695d58dd10ec335d64ece00152346c84ae750ed5ade8faf5ba11747135d79972dd1a3f4f1ab496ae9425ebcf7232a4203ca9396fa7e0  rootfs-usr-lib-sysusers.d-10-pmos-user.conf
0779c6d5959aef0e325adb69f3e0720a3f271f474c0f14e9c830f015c923c432d07222a24ce722a3ea58670d2eff3536d45bcaf7ae848b587676f1586a348e0e  rootfs-usr-lib-tmpfiles.d-opt.conf
7d98cb314472d7db64599c8abfc2e21ef6437b0c5bf407f0c21a42ec2f14f660fb3aef64c99a13aada124a822a85d8e4a6674838d1fe07719774331121d5414b  rootfs-usr-lib-tmpfiles.d-var.conf
4aa9c49faa69f66750eec519762fbf85715a9ce0882764b4dece795e391bead4dd6a02a5773e3a81382a8405f57a1e2f70fce31ae6e54c5182c9f2baf30993dd  rootfs-usr-share-f0rmz-f0rmz.conf.d-firstboot.conf
65ceb296d8da2e54e679aad65c6b7cdd8b5fd4a0d1a5fdde795a027f61be6822a8c9155b22dd1974ebab6bb8570119566b553cb77d02cbf871789d18951c0860  rootfs-usr-share-mkinitfs-files-extra-10-duranium-base.files
99325a25d1a588923bf55c9c803ea6aa8d7b7e82b929e4edafc47b39630d0c229bda89ea3afff1adde4136c2378ffb8ef24a4edbac015032975f40edcbad74ed  rootfs-usr-share-mkinitfs-modules-extra-10-duranium-base.modules
97bce380b5c4019aafad6f52856586ffaa4e17efd83f61f133e197bd833a35140406d206f572fb38444c42051b0d1dc789f44313aaf63bf0d4028499cc942b7e  rootfs-usr-bin-do-factory-reset
"
