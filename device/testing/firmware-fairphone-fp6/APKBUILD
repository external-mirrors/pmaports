# Maintainer: Luca Weiss <luca@lucaweiss.eu>
pkgname=firmware-fairphone-fp6
pkgver=20250606
pkgrel=2
pkgdesc="Firmware for The Fairphone (Gen. 6)"
subpackages="
	$pkgname-adreno
	$pkgname-adsp
	$pkgname-bluetooth
	$pkgname-cdsp
	$pkgname-hexagonfs
	$pkgname-ipa
	$pkgname-modem
	$pkgname-venus
	$pkgname-wpss
	"
url="https://github.com/FairBlobs/FP6-firmware"
arch="aarch64"
license="proprietary"
makedepends="pil-squasher"
options="!check !strip !archcheck !tracedeps pmb:cross-native"
_commit="63962e04b68cdba034b778c97878b97d5e1d8498"
source="https://github.com/FairBlobs/FP6-firmware/archive/$_commit/FP6-firmware-$_commit.tar.gz"
builddir="$srcdir/FP6-firmware-$_commit"

build() {
	for i in *.mdt; do
		pil-squasher "$(basename "$i" .mdt)".mbn "$i"
	done
}

package() {
	# parent package is empty
	mkdir -p "$pkgdir"
}

adreno() {
	pkgdesc="The Fairphone (Gen. 6) adreno firmware"

	install -Dm644 "$builddir"/gen80300_zap.mbn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
}

adsp() {
	pkgdesc="The Fairphone (Gen. 6) adsp firmware"

	install -Dm644 "$builddir"/adsp*.mbn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
	install -Dm644 "$builddir"/adsp*.jsn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
	install -Dm644 "$builddir"/battmgr.jsn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
}

bluetooth() {
	pkgdesc="The Fairphone (Gen. 6) bluetooth firmware"

	install -Dm644 "$builddir"/msbtfw12.mbn -t \
		"$subpkgdir/lib/firmware/qca/"
	install -Dm644 "$builddir"/msnv12.bin -t \
		"$subpkgdir/lib/firmware/qca/"
}

cdsp() {
	pkgdesc="The Fairphone (Gen. 6) cdsp firmware"

	install -Dm644 "$builddir"/cdsp*.mbn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
	install -Dm644 "$builddir"/cdsp*.jsn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
}

hexagonfs() {
	pkgdesc="The Fairphone (Gen. 6) hexagonfs files"

	mkdir -p "$subpkgdir"/usr/share/qcom/milos/Fairphone/
	cp -r "$builddir"/hexagonfs/ \
		"$subpkgdir"/usr/share/qcom/milos/Fairphone/fp6

	# Remove files that we don't need - for now
	#rm -r "$subpkgdir"/usr/share/qcom/milos/Fairphone/fp6/acdb/
	#rm -r "$subpkgdir"/usr/share/qcom/milos/Fairphone/fp6/dsp/

	find "$subpkgdir/usr/share/qcom/milos/Fairphone/fp6/" \
		-type f -exec chmod 0644 {} \;
}

ipa() {
	pkgdesc="The Fairphone (Gen. 6) ipa firmware"

	install -Dm644 "$builddir"/ipa_fws.mbn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
}

modem() {
	pkgdesc="The Fairphone (Gen. 6) modem firmware"

	install -Dm644 "$builddir"/modem.mbn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
	install -Dm644 "$builddir"/modem*.jsn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"

	cp -r "$builddir"/modem_pr/ \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
	find "$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/" \
		-type f -exec chmod 0644 {} \;
}

venus() {
	pkgdesc="The Fairphone (Gen. 6) venus firmware"

	install -Dm644 "$builddir"/vpu20_2v.mbn \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/venus.mbn"
}

wpss() {
	pkgdesc="The Fairphone (Gen. 6) wpss firmware"

	install -Dm644 "$builddir"/wpss.mbn -t \
		"$subpkgdir/lib/firmware/qcom/milos/fairphone/fp6/"
}

sha512sums="
a4589d67a4389de342be55b1d3ae207d327c2c70503d32190a0e3f8df087daf7737e6857725524cd61d311a3c0345c0cb47d2fbdd916af970e8e2872d48e00de  FP6-firmware-63962e04b68cdba034b778c97878b97d5e1d8498.tar.gz
"
