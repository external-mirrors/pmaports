# Maintainer: Clayton Craft <clayton@craftyguy.net>
# Reference: <https://postmarketos.org/devicepkg>
pkgname=device-apple-mac-aarch64
pkgdesc="Apple M-series Macs"
pkgver=2
pkgrel=0
url="https://postmarketos.org"
license="MIT"
arch="aarch64"
options="!check !archcheck"
depends="
	alsa-ucm-conf-asahi
	asahi-audio
	asahi-fwextract
	asahi-scripts
	linux-postmarketos-asahi
	postmarketos-base
	systemd-boot
	u-boot-asahi
"
makedepends="devicepkg-dev systemd-boot"
source="
	deviceinfo
	initramfs_copy_vendorfw.sh
	initramfs_setup_vendorfw.sh
	modules-initfs
	os-installer-deploy.sh
"
subpackages="$pkgname-os-installer:os_installer"

build() {
	devicepkg_build $startdir $pkgname
}

package() {
	devicepkg_package $startdir $pkgname

	# vendor firmware management scripts
	install -Dm755 "$srcdir"/initramfs_setup_vendorfw.sh \
		-t "$pkgdir"/usr/share/mkinitfs/hooks/
	install -Dm755 "$srcdir"/initramfs_copy_vendorfw.sh \
		-t "$pkgdir"/usr/share/mkinitfs/hooks-cleanup/

	# os-installer support
	install -Dm755 "$srcdir"/os-installer-deploy.sh \
		"$pkgdir"/etc/os-installer/deploy.sh

	# u-boot-asahi has a trigger that installs m1n1+u-boot and expects this dir to
	# exist, or else it crashes. This dir won't exist when building a new
	# install/image so we have to create it manually.
	mkdir -p "$pkgdir/boot/m1n1"
}

os_installer() {
	install_if="$pkgname=$pkgver-r$pkgrel postmarketos-ui-os-installer"
	description="Support for using os-installer"
	depends="gojq"

	amove etc/os-installer/deploy.sh
}

sha512sums="
42a8fe25e024a9cec7b900ddbb2bd1275810b80bafadc043e571e060c76c8aa0eb545c5ad4714aa6ce0354785187ae987827dfc3b3948d7d9901575bbc2a70b0  deviceinfo
f111ddc0484f079af23520dcc9b4d909b55da327aec91545921a4ceafc52b21d88f37fbdb702e51ca1e49440b6afc2011ada8b681c1801f572bddc9cd34c9d9e  initramfs_copy_vendorfw.sh
11d5d6af50ed73e7e6940f7d56730f94a1bb42990d5dba9a798522060e7717c410c025b12def0345b4f43c97da268dabcb484c3004d23c1ac39b1eeaaefd2967  initramfs_setup_vendorfw.sh
0191bc032cf8c72b397955d51f42249cd43d4aef263608a58d68e6e0764fd89bd589df97a5af22201930f289a64af7eb798cef5938cb6cc32d2382a627e6c10f  modules-initfs
7b9a75b2d471be7eef06d4f4b6bff64a2164fd23332311388e1a1962a63b18dfed4d2252a910302313f556c84030ef92cdca4f853f9076874776db070b1c09cc  os-installer-deploy.sh
"
